name: Deploy Backend

on:
  push:
    branches:
      - main
    
   
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: go.sum

    - name: Get dependencies
      run: go mod download

    - name: Run tests
      run: go test ./... -v || true

    - name: Build Backend
      run: |
        GOOS=linux GOARCH=amd64 go build -o registration-api main.go
        echo "Backend built successfully"
        ls -lh registration-api

    - name: Upload binary to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USERNAME }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: ${{ secrets.BACKEND_PORT || 22 }}
        source: "registration-api"
        target: "/tmp"
        timeout: 60s

    - name: Execute deployment on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USERNAME }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: ${{ secrets.BACKEND_PORT || 22 }}
        timeout: 60s
        script: |
          set -e
          
          # Make binary executable
          sudo chmod +x /tmp/registration-api
          
          # Create production directory if not exists
          sudo mkdir -p /var/www/registration-system/backend
          
          # Create backup of old binary
          if [ -f /var/www/registration-system/backend/registration-api ]; then
            sudo cp /var/www/registration-system/backend/registration-api /var/www/registration-system/backend/registration-api.backup.$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # Setup systemd service file if it doesn't exist
          SERVICE_FILE="/etc/systemd/system/registration-api.service"
          if [ ! -f "$SERVICE_FILE" ]; then
            echo "⚠️  Service file not found. Creating systemd service file..."
            
            # Get environment variables from GitHub Secrets or use defaults
            PORT_VALUE="${{ secrets.PORT || '3000' }}"
            CORS_ORIGIN_VALUE="${{ secrets.CORS_ORIGIN || 'https://mostdata.site' }}"
            DB_HOST_VALUE="${{ secrets.DB_HOST || 'localhost' }}"
            DB_PORT_VALUE="${{ secrets.DB_PORT || '5432' }}"
            DB_USER_VALUE="${{ secrets.DB_USER || 'registration_user' }}"
            DB_PASSWORD_VALUE="${{ secrets.DB_PASSWORD || 'your_secure_password' }}"
            DB_NAME_VALUE="${{ secrets.DB_NAME || 'registration_db' }}"
            DB_SSL_MODE_VALUE="${{ secrets.DB_SSL_MODE || 'disable' }}"
            DB_CHANNEL_BINDING_VALUE="${{ secrets.DB_CHANNEL_BINDING || '' }}"
            
            # Create service file
            sudo tee $SERVICE_FILE > /dev/null <<SERVICEEOF
          [Unit]
          Description=Registration System API (mostdata.site)
          After=network.target postgresql.service
          Requires=postgresql.service
          
          [Service]
          Type=simple
          User=www-data
          Group=www-data
          WorkingDirectory=/var/www/registration-system/backend
          ExecStart=/var/www/registration-system/backend/registration-api
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          
          # Environment variables
          Environment="PORT=$PORT_VALUE"
          Environment="CORS_ORIGIN=$CORS_ORIGIN_VALUE"
          Environment="DB_HOST=$DB_HOST_VALUE"
          Environment="DB_PORT=$DB_PORT_VALUE"
          Environment="DB_USER=$DB_USER_VALUE"
          Environment="DB_PASSWORD=$DB_PASSWORD_VALUE"
          Environment="DB_NAME=$DB_NAME_VALUE"
          Environment="DB_SSL_MODE=$DB_SSL_MODE_VALUE"
          SERVICEEOF
            
            if [ -n "$DB_CHANNEL_BINDING_VALUE" ]; then
              echo "Environment=\"DB_CHANNEL_BINDING=$DB_CHANNEL_BINDING_VALUE\"" | sudo tee -a $SERVICE_FILE > /dev/null
            fi
            
            cat <<'SERVICEEOF' | sudo tee -a $SERVICE_FILE > /dev/null
          
          # Security settings
          NoNewPrivileges=true
          PrivateTmp=true
          
          # Resource limits
          LimitNOFILE=65536
          
          [Install]
          WantedBy=multi-user.target
          SERVICEEOF
            
            sudo systemctl daemon-reload
            sudo systemctl enable registration-api
            echo "✅ Systemd service file created and enabled"
          else
            echo "ℹ️  Service file already exists"
            # Reload systemd daemon (in case service file was updated manually)
            sudo systemctl daemon-reload || true
          fi
          
          # Update .env file from GitHub Secrets (optional - for backward compatibility)
          # Note: Environment variables from systemd service file take precedence
          ENV_FILE="/var/www/registration-system/backend/.env"
          if [ -n "${{ secrets.DB_HOST }}" ]; then
            echo "Updating .env file from GitHub Secrets..."
            cat > /tmp/backend.env <<ENVEOF
          PORT=${{ secrets.PORT || '3000' }}
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN || 'https://mostdata.site' }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT || '5432' }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_SSL_MODE=${{ secrets.DB_SSL_MODE || 'disable' }}
          DB_CHANNEL_BINDING=${{ secrets.DB_CHANNEL_BINDING }}
          ENVEOF
            sudo mv /tmp/backend.env $ENV_FILE
            sudo chown www-data:www-data $ENV_FILE
            sudo chmod 600 $ENV_FILE
            echo "✅ .env file updated from GitHub Secrets"
          fi
          
          # Stop backend service if running
          if systemctl is-active --quiet registration-api 2>/dev/null; then
            echo "Stopping existing service..."
            sudo systemctl stop registration-api || true
          else
            echo "Service is not running (first deployment?)"
          fi
          
          # Move new binary to production directory
          sudo mv /tmp/registration-api /var/www/registration-system/backend/
          
          # Set ownership
          sudo chown root:root /var/www/registration-system/backend/registration-api
          
          # Start backend service
          echo "Starting backend service..."
          sudo systemctl start registration-api
          
          # Wait for service to start
          sleep 3
          
          # Check status
          sudo systemctl status registration-api --no-pager || true
          
          # Check if service is running
          if sudo systemctl is-active --quiet registration-api; then
            echo "✅ Backend deployment completed successfully!"
          else
            echo "❌ Backend service failed to start"
            echo "Checking logs..."
            sudo journalctl -u registration-api -n 20 --no-pager || true
            sudo systemctl status registration-api --no-pager
            exit 1
          fi

    - name: Deployment status
      if: always()
      run: |
        echo "Deployment finished with status: ${{ job.status }}"
