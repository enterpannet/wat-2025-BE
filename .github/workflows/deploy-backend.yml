name: Deploy Backend

on:
  push:
    branches:
      - main
      - master
    paths:
      - '**'
      - '!.github/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: go.sum

    - name: Get dependencies
      run: go mod download

    - name: Run tests
      run: go test ./... -v || true

    - name: Build Backend
      run: |
        GOOS=linux GOARCH=amd64 go build -o registration-api main.go
        echo "Backend built successfully"
        ls -lh registration-api

    - name: Upload binary to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USERNAME }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: ${{ secrets.BACKEND_PORT || 22 }}
        source: "registration-api"
        target: "/tmp"
        timeout: 60s

    - name: Execute deployment on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USERNAME }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: ${{ secrets.BACKEND_PORT || 22 }}
        timeout: 60s
        script: |
          set -e
          
          # Make binary executable
          sudo chmod +x /tmp/registration-api
          
          # Create backup of old binary
          if [ -f /var/www/registration-system/backend/registration-api ]; then
            sudo cp /var/www/registration-system/backend/registration-api /var/www/registration-system/backend/registration-api.backup.$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # Stop backend service
          sudo systemctl stop registration-api || true
          
          # Create production directory if not exists
          sudo mkdir -p /var/www/registration-system/backend
          
          # Update .env file from GitHub Secrets (if provided)
          # หมายเหตุ: แนะนำให้ใช้ systemd service file แทน (.env file เป็น option)
          # ถ้ามี GitHub Secrets สำหรับ env variables จะสร้าง .env file
          # ถ้าไม่มี จะใช้ environment variables จาก systemd service file
          ENV_FILE="/var/www/registration-system/backend/.env"
          
          # สร้าง .env file จาก GitHub Secrets (ถ้ามี)
          if [ -n "${{ secrets.DB_HOST }}" ]; then
            echo "Updating .env file from GitHub Secrets..."
            cat > /tmp/backend.env <<ENVEOF
          PORT=${{ secrets.PORT || '3000' }}
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN || 'https://mostdata.site' }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT || '5432' }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_SSL_MODE=${{ secrets.DB_SSL_MODE || 'disable' }}
          DB_CHANNEL_BINDING=${{ secrets.DB_CHANNEL_BINDING }}
          ENVEOF
            sudo mv /tmp/backend.env $ENV_FILE
            sudo chown www-data:www-data $ENV_FILE
            sudo chmod 600 $ENV_FILE
            echo "✅ .env file updated from GitHub Secrets"
          else
            echo "ℹ️  No environment variables provided in GitHub Secrets"
            echo "ℹ️  Using systemd service file environment variables instead"
            echo "ℹ️  Make sure /etc/systemd/system/registration-api.service has Environment variables set"
          fi
          
          # Move new binary to production directory
          sudo mv /tmp/registration-api /var/www/registration-system/backend/
          
          # Set ownership
          sudo chown root:root /var/www/registration-system/backend/registration-api
          
          # Reload systemd daemon (in case service file was updated)
          sudo systemctl daemon-reload || true
          
          # Restart backend service
          sudo systemctl start registration-api
          
          # Wait for service to start
          sleep 3
          
          # Check status
          sudo systemctl status registration-api --no-pager || true
          
          # Check if service is running
          if sudo systemctl is-active --quiet registration-api; then
            echo "✅ Backend deployment completed successfully!"
          else
            echo "❌ Backend service failed to start"
            sudo systemctl status registration-api --no-pager
            exit 1
          fi

    - name: Deployment status
      if: always()
      run: |
        echo "Deployment finished with status: ${{ job.status }}"
