name: Deploy Backend

on:
  push:
    branches:
      - main
    
   
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: go.sum

    - name: Get dependencies
      run: go mod download

    - name: Run tests
      run: go test ./... -v || true

    - name: Build Backend
      run: |
        GOOS=linux GOARCH=amd64 go build -o registration-api main.go
        echo "Backend built successfully"
        ls -lh registration-api

    - name: Upload binary to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USERNAME }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: ${{ secrets.BACKEND_PORT || 22 }}
        source: "registration-api"
        target: "/tmp"
        timeout: 60s

    - name: Execute deployment on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.BACKEND_HOST }}
        username: ${{ secrets.BACKEND_USERNAME }}
        key: ${{ secrets.BACKEND_SSH_KEY }}
        port: ${{ secrets.BACKEND_PORT || 22 }}
        timeout: 60s
        script: |
          set -e
          
          # Make binary executable
          sudo chmod +x /tmp/registration-api
          
          # Create production directory if not exists
          sudo mkdir -p /var/www/registration-system/backend
          
          # Create backup of old binary
          if [ -f /var/www/registration-system/backend/registration-api ]; then
            sudo cp /var/www/registration-system/backend/registration-api /var/www/registration-system/backend/registration-api.backup.$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # Setup systemd service file - always update to ensure correct configuration
          SERVICE_FILE="/etc/systemd/system/registration-api.service"
          
          # Stop service before updating service file
          if systemctl is-active --quiet registration-api 2>/dev/null; then
            echo "Stopping service before updating service file..."
            sudo systemctl stop registration-api || true
          fi
          
          # Get environment variables from GitHub Secrets or use defaults
          PORT_VALUE="${{ secrets.PORT || '3000' }}"
          CORS_ORIGINS_VALUE="${{ secrets.CORS_ORIGINS || 'https://mostdata.site,https://www.mostdata.site' }}"
          HTTPS_ENABLED_VALUE="${{ secrets.HTTPS_ENABLED || 'true' }}"
          ENVIRONMENT_VALUE="${{ secrets.ENVIRONMENT || 'production' }}"
          DB_HOST_VALUE="${{ secrets.DB_HOST || 'localhost' }}"
          DB_PORT_VALUE="${{ secrets.DB_PORT || '5432' }}"
          DB_USER_VALUE="${{ secrets.DB_USER || 'registration_user' }}"
          DB_PASSWORD_VALUE="${{ secrets.DB_PASSWORD || 'your_secure_password' }}"
          DB_NAME_VALUE="${{ secrets.DB_NAME || 'registration_db' }}"
          DB_SSL_MODE_VALUE="${{ secrets.DB_SSL_MODE || 'disable' }}"
          DB_CHANNEL_BINDING_VALUE="${{ secrets.DB_CHANNEL_BINDING || '' }}"
          
          # Create/update service file
          # Note: PostgreSQL is running in Docker, so no systemd service dependency needed
          echo "Updating systemd service file..."
          {
            echo "[Unit]"
            echo "Description=Registration System API (mostdata.site)"
            echo "After=network.target docker.service"
            echo "Wants=docker.service"
            echo ""
            echo "[Service]"
            echo "Type=simple"
            echo "User=www-data"
            echo "Group=www-data"
            echo "WorkingDirectory=/var/www/registration-system/backend"
            echo "ExecStart=/var/www/registration-system/backend/registration-api"
            echo "Restart=always"
            echo "RestartSec=5"
            echo "StandardOutput=journal"
            echo "StandardError=journal"
            echo ""
            echo "# Environment variables"
            echo "Environment=\"PORT=$PORT_VALUE\""
            echo "Environment=\"CORS_ORIGINS=$CORS_ORIGINS_VALUE\""
            echo "Environment=\"HTTPS_ENABLED=$HTTPS_ENABLED_VALUE\""
            echo "Environment=\"ENVIRONMENT=$ENVIRONMENT_VALUE\""
            echo "Environment=\"DB_HOST=$DB_HOST_VALUE\""
            echo "Environment=\"DB_PORT=$DB_PORT_VALUE\""
            echo "Environment=\"DB_USER=$DB_USER_VALUE\""
            echo "Environment=\"DB_PASSWORD=$DB_PASSWORD_VALUE\""
            echo "Environment=\"DB_NAME=$DB_NAME_VALUE\""
            echo "Environment=\"DB_SSL_MODE=$DB_SSL_MODE_VALUE\""
          } | sudo tee $SERVICE_FILE > /dev/null
          
          if [ -n "$DB_CHANNEL_BINDING_VALUE" ]; then
            echo "Environment=\"DB_CHANNEL_BINDING=$DB_CHANNEL_BINDING_VALUE\"" | sudo tee -a $SERVICE_FILE > /dev/null
          fi
          
          # Append security and install settings
          {
            echo ""
            echo "# Security settings"
            echo "NoNewPrivileges=true"
            echo "PrivateTmp=true"
            echo ""
            echo "# Resource limits"
            echo "LimitNOFILE=65536"
            echo ""
            echo "[Install]"
            echo "WantedBy=multi-user.target"
          } | sudo tee -a $SERVICE_FILE > /dev/null
          
          sudo systemctl daemon-reload
          sudo systemctl enable registration-api
          echo "✅ Systemd service file updated"
          
          # Update .env file from GitHub Secrets (optional - for backward compatibility)
          # Note: Environment variables from systemd service file take precedence
          ENV_FILE="/var/www/registration-system/backend/.env"
          if [ -n "${{ secrets.DB_HOST }}" ]; then
            echo "Updating .env file from GitHub Secrets..."
            cat > /tmp/backend.env <<ENVEOF
          PORT=${{ secrets.PORT || '3000' }}
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS || 'https://mostdata.site,https://www.mostdata.site' }}
          HTTPS_ENABLED=${{ secrets.HTTPS_ENABLED || 'true' }}
          ENVIRONMENT=${{ secrets.ENVIRONMENT || 'production' }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT || '5432' }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_SSL_MODE=${{ secrets.DB_SSL_MODE || 'disable' }}
          DB_CHANNEL_BINDING=${{ secrets.DB_CHANNEL_BINDING }}
          ENVEOF
            sudo mv /tmp/backend.env $ENV_FILE
            sudo chown www-data:www-data $ENV_FILE
            sudo chmod 600 $ENV_FILE
            echo "✅ .env file updated from GitHub Secrets"
          fi
          
          # Service was already stopped before updating service file
          echo "Service is ready to start"
          
          # Move new binary to production directory
          sudo mv /tmp/registration-api /var/www/registration-system/backend/
          
          # Set ownership
          sudo chown root:root /var/www/registration-system/backend/registration-api
          
          # Start backend service
          echo "Starting backend service..."
          sudo systemctl start registration-api
          
          # Wait for service to start
          sleep 3
          
          # Check status
          sudo systemctl status registration-api --no-pager || true
          
          # Check if service is running
          if sudo systemctl is-active --quiet registration-api; then
            echo "✅ Backend deployment completed successfully!"
          else
            echo "❌ Backend service failed to start"
            echo "Checking logs..."
            sudo journalctl -u registration-api -n 20 --no-pager || true
            sudo systemctl status registration-api --no-pager
            exit 1
          fi

    - name: Deployment status
      if: always()
      run: |
        echo "Deployment finished with status: ${{ job.status }}"
